function Coordinate(e,t){this.longitude=e,this.latitude=t}function City(e,t,n,o){this.name=e,this.completeName=t,this.countryCode=n,this.coordinate=o}function initialize(){ko.applyBindings(new localNewsViewModel);var e=function(){var e=$(window).height();$("#map-canvas").height(.92*e),$(".inner-scrollbar").css({"max-height":.92*e})};$(document).ready(e),window.addEventListener("resize",e)}function getThumbnail(e){return getResizeImage(e,64)}function getResizeImage(e,t){return e?EMBEDLY_RESIZE_IMAGE_SERVICE_URL+"key="+EMBEDLY_API_KEY+"&url="+e+"&width="+t+"&grow=false":e}function News(e,t,n,o,i,r,s){this.street=e,this.longitude=ko.observable(),this.latitude=ko.observable(),this.date=new Date(t),this.description=n,this.title=o,this.url=i,this.imgsrc=ko.observable(s),this.source=r}function getNews(e,t,n){function o(e,t){var n=e+":"+t,o=btoa(n);return"Basic "+o}function i(e){var t="([A-Z][a-z]+ )+(([Ss]treet)|([Ss]t))",n=new RegExp(t),o=n.exec(e);return o?o[0]:o}var r=this,s=BING_NEWS_QUERY;BING_NEWS_MARKETS[e.countryCode]&&(s+="?Market='"+BING_NEWS_MARKETS[e.countryCode]+"'");for(var a=0,c={},l=function(e){e.setRequestHeader("Authorization",o("",BING_API_KEY))},u=function(o){for(var r,s,a=0;a<o.d.results.length;a++)if(r=i(o.d.results[a].Description),r&&(s=r.replace(" ","").toLowerCase(),!c[s])){c[s]=r;var l=new n(r+" "+e.completeName,o.d.results[a].Date,o.d.results[a].Description,o.d.results[a].Title,o.d.results[a].Url,o.d.results[a].Source,null);pinPosterLocation(l.street,l.latitude,l.longitude),getUrlExtraData(l.url,l.imgsrc),t.push(l)}},d=function(){console.log("pinPosterNew error"+e)},p=1;NEWS_SEARCH_PAGES>=p;p++)$.ajax({type:"GET",url:s,dataType:"json",context:r,data:{$skip:a,$top:15,Query:"'street "+e.name+"'"},beforeSend:l,success:u,error:d}),a+=15}function pinPosterLocation(e,t,n){var o=this;$.ajax({type:"GET",url:MAPS_GEOCODE_API_URL,dataType:"json",context:o,data:{address:e,key:GOOGLE_API_KEY},success:function(e){return 0===e.results.length?(t(0),void n(0)):(n(e.results[0].geometry.location.lng),void t(e.results[0].geometry.location.lat))},error:function(){console.log("pinPosterNew error"+e)}})}function getUrlExtraData(e,t){var n="http://api.embed.ly/1/oembed?",o=this;$.ajax({type:"GET",url:n,dataType:"jsonp",context:o,data:{key:EMBEDLY_API_KEY,url:e},success:function(e){t(e.thumbnail_url)},error:function(){console.log("getNewsData error"+e)}})}function getCurrentLocation(e){$.get("http://ipinfo.io",function(t){var n=t.loc.split(","),o={vicinity:t.city,formatted_address:t.city+", "+t.country,address_components:[{short_name:t.country,types:["country"]}],geometry:{location:{A:n[0],F:n[1]}}};e(o)},"jsonp")}function localNewsViewModel(){var e=this;e.currentNews=ko.observableArray(),e.currentLocation=ko.observable(),e.visibleNewsCount=ko.observable(0),e.query=ko.observable(),e.currentCity=ko.computed(function(){if(e.currentLocation()){for(var t,n=e.currentLocation(),o=n.address_components,i=0;i<o.length;i++)-1!=o[i].types.indexOf("country")&&(t=o[i].short_name);var r=new City(n.vicinity,n.formatted_address,t,new Coordinate(n.geometry.location.A,n.geometry.location.F));return e.currentNews.removeAll(),getNews(r,e.currentNews,e.ExtdNew),r}},e),e.visibleNewsCounter=function(){for(var t=0,n=0;n<e.currentNews().length;n++)e.currentNews()[n].visible()&&t++;e.visibleNewsCount(t)},e.currentNews.subscribe(e.visibleNewsCounter),e.ExtdNew=function(e,t,n,o,i,r,s){News.call(this,e,t,n,o,i,r,s),this.visible=ko.observable(!0),this.isSelected=ko.observable(!1),this.clicked=ko.observable(!1),this.visible.subscribe(this.visibleNewsCounter)},e.ExtdNew.prototype.visibleNewsCounter=e.visibleNewsCounter,getCurrentLocation(e.currentLocation),e.hideNew=function(e){e.visible(!1)},e.deleteNew=function(t){e.currentNews.remove(t)},e.showAll=function(){for(var t=0;t<e.currentNews().length;t++)e.currentNews()[t].visible(!0)},e.hideAll=function(){for(var t=0;t<e.currentNews().length;t++)e.currentNews()[t].visible(!1)},e.setSelected=function(e){e.isSelected(!0)},e.noSelected=function(e){e.isSelected(!1)},e.clickedfn=function(e){e.clicked(!e.clicked())},e.filter=function(t){e.hideAll();var n=e.currentNews(),o="";for(var i in n)o=(n[i].title+" "+n[i].description).toLowerCase(),o.indexOf(t.toLowerCase())>=0&&n[i].visible(!0)},e.query.subscribe(e.filter),e.sortByDate=function(){this._ascOrder=this._ascOrder?!this._ascOrder:!0,e.currentNews.sort(function(e,t){return e.date==t.date?0:e.date<t.date?-1:1}),this._ascOrder||e.currentNews.reverse()}}var GOOGLE_API_KEY="AIzaSyDwaX72ZHH6uRu8AABAIcFc0nKEpqBCV3U",MAPS_GEOCODE_API_URL="https://maps.googleapis.com/maps/api/geocode/json",BING_API_KEY="9XRXbONaSXn/TJ8YDbdpf3mZUB0B2rm7SdpPBEzq0yE",googleMap,BING_NEWS_QUERY="https://api.datamarket.azure.com/Bing/Search/v1/News",EMBEDLY_API_KEY="d347b17304734ba1b66461039c7d34d1",NEWS_SEARCH_PAGES=15,BING_NEWS_MARKETS={AU:"en-AU",CA:"en-CA",GB:"en-GB",UK:"en-GB",ID:"en-ID",IE:"en-IE",IN:"en-IN",MY:"en-MY",NZ:"en-NZ",PH:"en-PH",SG:"en-SG",US:"en-US",XA:"en-XA",ZA:"en-ZA"},EMBEDLY_RESIZE_IMAGE_SERVICE_URL="http://i.embed.ly/1/image/resize?",getFormatedDate=function(e){return e.toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})};ko.bindingHandlers.mapForeach={init:function(e,t,n,o,i){var r=this;googleMap=new google.maps.Map(document.querySelector("#"+n().map_div_id),{zoom:11});var s=n().place;return s.subscribe(function(){n().map.setCenter(new google.maps.LatLng(s().coordinate.longitude,s().coordinate.latitude))},r),ko.bindingHandlers.foreach.init(e,t,n,o,i)},update:function(e,t,n,o,i){return ko.bindingHandlers.foreach.update(e,t,n,o,i)}},ko.bindingHandlers.mapMarker={init:function(e,t,n,o,i){try{var r=this,s=n().news,a=n().selecEvnObsv,c=n().visibleEvntOsv,l=n().clickEvntOsv,u=new google.maps.LatLng(s.latitude(),s.longitude()),d=new google.maps.Marker({map:n().map,position:u,title:s.title});s._mapMarker=d,ko.utils.domNodeDisposal.addDisposeCallback(e,function(){var t=ko.dataFor(e);console.log("deletd"+t),t._mapMarker.setMap(null)}),s._infoWindow=ko.computed(function(){var e='<div id="content"><div id="siteNotice"></div><h4 id="firstHeading" class="firstHeading">'+s.street+'</h4><img src="'+getThumbnail(s.imgsrc())+'" width="64px"><div id="bodyContent"><p><b>'+s.title+"</b>, "+s.description+' </p><a href="'+s.url+'">'+s.source+'</a> <span style="font-size: 8pt"> '+s.date.toLocaleDateString();return new google.maps.InfoWindow({content:e,maxWidth:250})},r),l.subscribe(function(){s._infoWindow().getMap()?s._infoWindow().close():s._infoWindow().open(n().map,s._mapMarker)},r),c.subscribe(function(){s._mapMarker.setMap(s.visible()?n().map:null)},r),a.subscribe(function(){var e=s.isSelected()?google.maps.Animation.BOUNCE:null;s._mapMarker.setAnimation(e)},r),google.maps.event.addListener(d,"mouseover",function(){a(!0),s._mapMarker.setAnimation(null)}),google.maps.event.addListener(d,"mouseout",function(){a(!1)}),google.maps.event.addListener(d,"click",function(){s._infoWindow().getMap()?s._infoWindow().close():s._infoWindow().open(n().map,d)})}catch(p){console.log(p)}},update:function(e,t,n,o){try{var i=n().news,r=new google.maps.LatLng(i.latitude(),i.longitude());i._mapMarker.setPosition(r)}catch(s){console.log(s)}}},ko.bindingHandlers.addressAutocomplete={init:function(e,t,n){var o=n(),i={};ko.utils.extend(i,o.autocompleteOptions);var r=new google.maps.places.Autocomplete(e,i);google.maps.event.addListener(r,"place_changed",function(){o.output(r.getPlace())})},update:function(e,t,n){ko.bindingHandlers.value.update(e,t)}};