function Coordinate(e,n){this.longitude=e,this.latitude=n}function City(e,n,t,i){this.name=e,this.completeName=n,this.countryCode=t,this.coordinate=i}function initialize(){ko.applyBindings(new localNewsViewModel);var e=function(){var e=$(window).height();$("#map-canvas").height(.92*e),$(".inner-scrollbar").css({"max-height":.92*e})};$(document).ready(e),window.addEventListener("resize",e);var n=function(){"up"===Offline.state&&Offline.check()};setInterval(n,5e3)}function getThumbnail(e){return getResizeImage(e,64)}function getResizeImage(e,n){return e?EMBEDLY_RESIZE_IMAGE_SERVICE_URL+"key="+EMBEDLY_API_KEY+"&url="+e+"&width="+n+"&grow=false":e}function News(e,n,t,i,o,r,a){this.street=e,this.longitude=ko.observable(),this.latitude=ko.observable(),this.date=new Date(n),this.description=t,this.title=i,this.url=o,this.imgsrc=ko.observable(a),this.source=r}function getNews(e,n,t){function i(e,n){var t=e+":"+n,i=btoa(t);return"Basic "+i}function o(e){var n="([A-Z][a-z]+ )+(([Ss]treet)|([Ss]t))",t=new RegExp(n),i=t.exec(e);return i?i[0]:i}var r=this,a=BING_NEWS_QUERY;BING_NEWS_MARKETS[e.countryCode]&&(a+="?Market='"+BING_NEWS_MARKETS[e.countryCode]+"'");for(var s=0,u={},c=function(e){e.setRequestHeader("Authorization",i("",BING_API_KEY))},l=function(i){for(var r,a,s=0,c=i.d.results.length;c>s;s++)if(r=o(i.d.results[s].Description),r&&(a=r.replace(" ","").toLowerCase(),!u[a])){u[a]=r;var l=new t(r+" "+e.completeName,i.d.results[s].Date,i.d.results[s].Description,i.d.results[s].Title,i.d.results[s].Url,i.d.results[s].Source,null);pinPosterLocation(l.street,l.latitude,l.longitude),getUrlExtraData(l.url,l.imgsrc),n.push(l)}},f=function(){console.log("pinPosterNew error"+e)},d=1;NEWS_SEARCH_PAGES>=d;d++)$.ajax({type:"GET",url:a,dataType:"json",context:r,data:{$skip:s,$top:15,Query:"'street "+e.name+"'"},beforeSend:c,success:l,error:f}),s+=15}function pinPosterLocation(e,n,t){var i=this;$.ajax({type:"GET",url:MAPS_GEOCODE_API_URL,dataType:"json",context:i,data:{address:e,key:GOOGLE_API_KEY},success:function(e){return 0===e.results.length?(n(0),void t(0)):(t(e.results[0].geometry.location.lng),void n(e.results[0].geometry.location.lat))},error:function(){console.log("pinPosterNew error"+e)}})}function getUrlExtraData(e,n){var t="http://api.embed.ly/1/oembed?",i=this;$.ajax({type:"GET",url:t,dataType:"jsonp",context:i,data:{key:EMBEDLY_API_KEY,url:e},success:function(e){n(e.thumbnail_url)},error:function(){console.log("getNewsData error"+e)}})}function getInitialCity(e){$.get("http://ipinfo.io",function(n){if(!n.city||"null"==n.city)return void e(DEFAUL_CITY_LOCATION);var t=n.loc.split(","),i={vicinity:n.city,formatted_address:n.city+", "+n.country,address_components:[{short_name:n.country,types:["country"]}],geometry:{location:{lat:function(){return t[0]},lng:function(){return t[1]}}}};e(i)},"jsonp")}function localNewsViewModel(){var e=this;e.currentNews=ko.observableArray(),e.currentLocation=ko.observable(),e.visibleNewsCount=ko.observable(0),e.query=ko.observable(),e.currentCity=ko.computed(function(){if(e.currentLocation()){for(var n,t=e.currentLocation(),i=t.address_components,o=0,r=i.length;r>o;o++)-1!=i[o].types.indexOf("country")&&(n=i[o].short_name);var a=new City(t.vicinity,t.formatted_address,n,new Coordinate(t.geometry.location.lat(),t.geometry.location.lng()));return e.currentNews.removeAll(),getNews(a,e.currentNews,e.ExtdNew),a}},e),e.visibleNewsCounter=function(){for(var n=0,t=0,i=e.currentNews().length;i>t;t++)e.currentNews()[t].visible()&&n++;e.visibleNewsCount(n)},e.currentNews.subscribe(e.visibleNewsCounter),e.ExtdNew=function(e,n,t,i,o,r,a){News.call(this,e,n,t,i,o,r,a),this.visible=ko.observable(!0),this.isSelected=ko.observable(!1),this.clicked=ko.observable(!1),this.visible.subscribe(this.visibleNewsCounter)},e.ExtdNew.prototype.visibleNewsCounter=e.visibleNewsCounter,getInitialCity(e.currentLocation),e.hideNew=function(e){e.visible(!1)},e.deleteNew=function(n){e.currentNews.remove(n)},e.showAll=function(){for(var n=0,t=e.currentNews().length;t>n;n++)e.currentNews()[n].visible(!0)},e.hideAll=function(){for(var n=0,t=e.currentNews().length;t>n;n++)e.currentNews()[n].visible(!1)},e.setSelected=function(e){e.isSelected(!0)},e.noSelected=function(e){e.isSelected(!1)},e.clickedfn=function(e){e.clicked(!e.clicked())},e.filter=function(n){e.hideAll();var t=e.currentNews(),i="";for(var o in t)i=(t[o].title+" "+t[o].description).toLowerCase(),i.indexOf(n.toLowerCase())>=0&&t[o].visible(!0)},e.query.subscribe(e.filter),e.sortByDate=function(){this._ascOrder=this._ascOrder?!this._ascOrder:!0,e.currentNews.sort(function(e,n){return e.date==n.date?0:e.date<n.date?-1:1}),this._ascOrder||e.currentNews.reverse()}}var GOOGLE_API_KEY="AIzaSyDwaX72ZHH6uRu8AABAIcFc0nKEpqBCV3U",MAPS_GEOCODE_API_URL="https://maps.googleapis.com/maps/api/geocode/json",BING_API_KEY="9XRXbONaSXn/TJ8YDbdpf3mZUB0B2rm7SdpPBEzq0yE",googleMap,BING_NEWS_QUERY="https://api.datamarket.azure.com/Bing/Search/v1/News",EMBEDLY_API_KEY="d347b17304734ba1b66461039c7d34d1",NEWS_SEARCH_PAGES=15,BING_NEWS_MARKETS={AU:"en-AU",CA:"en-CA",GB:"en-GB",UK:"en-GB",ID:"en-ID",IE:"en-IE",IN:"en-IN",MY:"en-MY",NZ:"en-NZ",PH:"en-PH",SG:"en-SG",US:"en-US",XA:"en-XA",ZA:"en-ZA"},EMBEDLY_RESIZE_IMAGE_SERVICE_URL="http://i.embed.ly/1/image/resize?",DEFAUL_CITY_LOCATION={vicinity:"London",formatted_address:"London, GB",address_components:[{short_name:"GB",types:["country"]}],geometry:{location:{lat:function(){return 51.5073509},lng:function(){return-.12775829999998223}}}},getFormatedDate=function(e){return e.toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})};ko.bindingHandlers.mapForeach={init:function(e,n,t,i,o){var r=this;googleMap=new google.maps.Map(document.querySelector("#"+t().map_div_id),{zoom:11});var a=t().place;return a.subscribe(function(){t().map.setCenter(new google.maps.LatLng(a().coordinate.longitude,a().coordinate.latitude))},r),ko.bindingHandlers.foreach.init(e,n,t,i,o)},update:function(e,n,t,i,o){return ko.bindingHandlers.foreach.update(e,n,t,i,o)}},ko.bindingHandlers.mapMarker={init:function(e,n,t,i,o){function r(){a.currentInfoWindow||(a.currentInfoWindow=s._infoWindow()),a.currentInfoWindow!=s._infoWindow()&&(a.currentInfoWindow.close(),a.currentInfoWindow=s._infoWindow()),a.currentInfoWindow.getMap()?a.currentInfoWindow.close():a.currentInfoWindow.open(t().map,s._mapMarker)}try{var a=this,s=t().news,u=t().selecEvnObsv,c=t().visibleEvntOsv,l=t().clickEvntOsv,f=new google.maps.LatLng(s.latitude(),s.longitude()),d=new google.maps.Marker({map:t().map,position:f,title:s.title});s._mapMarker=d,a.currentInfoWindow=null,ko.utils.domNodeDisposal.addDisposeCallback(e,function(){var n=ko.dataFor(e);n._mapMarker.setMap(null)}),s._infoWindow=ko.computed(function(){var e='<div id="content"><div id="siteNotice"></div><h4 id="firstHeading" class="firstHeading">'+s.street+'</h4><img src="'+getThumbnail(s.imgsrc())+'" width="64px"><div id="bodyContent"><p><b>'+s.title+"</b>, "+s.description+' </p><a href="'+s.url+'">'+s.source+'</a> <span style="font-size: 8pt"> '+s.date.toLocaleDateString();return new google.maps.InfoWindow({content:e,maxWidth:250})},a),l.subscribe(r,a),c.subscribe(function(){s._mapMarker.setMap(s.visible()?t().map:null)},a),u.subscribe(function(){var e=s.isSelected()?google.maps.Animation.BOUNCE:null;s._mapMarker.setAnimation(e)},a),google.maps.event.addListener(d,"mouseover",function(){u(!0),s._mapMarker.setAnimation(null)}),google.maps.event.addListener(d,"mouseout",function(){u(!1)}),google.maps.event.addListener(d,"click",r)}catch(p){console.log(p)}},update:function(e,n,t,i){try{var o=t().news,r=new google.maps.LatLng(o.latitude(),o.longitude());o._mapMarker.setPosition(r)}catch(a){console.log(a)}}},ko.bindingHandlers.addressAutocomplete={init:function(e,n,t){var i=t(),o={};ko.utils.extend(o,i.autocompleteOptions);var r=new google.maps.places.Autocomplete(e,o);google.maps.event.addListener(r,"place_changed",function(){i.output(r.getPlace())})},update:function(e,n,t){ko.bindingHandlers.value.update(e,n)}},/*! offline 0.7.11 */
function(){var e,n,t,i,o,r,a;i=function(e,n){var t,i,o,r;r=[];for(i in n.prototype)try{o=n.prototype[i],r.push(null==e[i]&&"function"!=typeof o?e[i]=o:void 0)}catch(a){t=a}return r},e={},null==e.options&&(e.options={}),t={checks:{xhr:{url:function(){return"/favicon.ico?_="+Math.floor(1e9*Math.random())},timeout:5e3},image:{url:function(){return"/favicon.ico?_="+Math.floor(1e9*Math.random())}},active:"xhr"},checkOnLoad:!1,interceptRequests:!0,reconnect:!0},o=function(e,n){var t,i,o,r,a,s;for(t=e,r=n.split("."),i=a=0,s=r.length;s>a&&(o=r[i],t=t[o],"object"==typeof t);i=++a);return i===r.length-1?t:void 0},e.getOption=function(n){var i,r;return i=null!=(r=o(e.options,n))?r:o(t,n),"function"==typeof i?i():i},"function"==typeof window.addEventListener&&window.addEventListener("online",function(){return setTimeout(e.confirmUp,100)},!1),"function"==typeof window.addEventListener&&window.addEventListener("offline",function(){return e.confirmDown()},!1),e.state="up",e.markUp=function(){return e.trigger("confirmed-up"),"up"!==e.state?(e.state="up",e.trigger("up")):void 0},e.markDown=function(){return e.trigger("confirmed-down"),"down"!==e.state?(e.state="down",e.trigger("down")):void 0},r={},e.on=function(n,t,i){var o,a,s,u,c;if(a=n.split(" "),a.length>1){for(c=[],s=0,u=a.length;u>s;s++)o=a[s],c.push(e.on(o,t,i));return c}return null==r[n]&&(r[n]=[]),r[n].push([i,t])},e.off=function(e,n){var t,i,o,a,s;if(null!=r[e]){if(n){for(i=0,s=[];i<r[e].length;)a=r[e][i],t=a[0],o=a[1],s.push(o===n?r[e].splice(i,1):i++);return s}return r[e]=[]}},e.trigger=function(e){var n,t,i,o,a,s,u;if(null!=r[e]){for(a=r[e],u=[],i=0,o=a.length;o>i;i++)s=a[i],n=s[0],t=s[1],u.push(t.call(n));return u}},n=function(e,n,t){var i,o,r,a,s;return i=function(){return e.status&&e.status<12e3?n():t()},null===e.onprogress?(o=e.onerror,e.onerror=function(){return t(),"function"==typeof o?o.apply(null,arguments):void 0},s=e.ontimeout,e.ontimeout=function(){return t(),"function"==typeof s?s.apply(null,arguments):void 0},r=e.onload,e.onload=function(){return i(),"function"==typeof r?r.apply(null,arguments):void 0}):(a=e.onreadystatechange,e.onreadystatechange=function(){return 4===e.readyState?i():0===e.readyState&&t(),"function"==typeof a?a.apply(null,arguments):void 0})},e.checks={},e.checks.xhr=function(){var t,i;i=new XMLHttpRequest,i.offline=!1,i.open("HEAD",e.getOption("checks.xhr.url"),!0),null!=i.timeout&&(i.timeout=e.getOption("checks.xhr.timeout")),n(i,e.markUp,e.markDown);try{i.send()}catch(o){t=o,e.markDown()}return i},e.checks.image=function(){var n;return n=document.createElement("img"),n.onerror=e.markDown,n.onload=e.markUp,void(n.src=e.getOption("checks.image.url"))},e.checks.down=e.markDown,e.checks.up=e.markUp,e.check=function(){return e.trigger("checking"),e.checks[e.getOption("checks.active")]()},e.confirmUp=e.confirmDown=e.check,e.onXHR=function(e){var n,t,o;return n=function(n,t){var i;return i=n.open,n.open=function(o,r,a,s,u){return e({type:o,url:r,async:a,flags:t,user:s,password:u,xhr:n}),i.apply(n,arguments)}},o=window.XMLHttpRequest,window.XMLHttpRequest=function(e){var t,i,r;return t=new o(e),n(t,e),r=t.setRequestHeader,t.headers={},t.setRequestHeader=function(e,n){return t.headers[e]=n,r.call(t,e,n)},i=t.overrideMimeType,t.overrideMimeType=function(e){return t.mimeType=e,i.call(t,e)},t},i(window.XMLHttpRequest,o),null!=window.XDomainRequest?(t=window.XDomainRequest,window.XDomainRequest=function(){var e;return e=new t,n(e),e},i(window.XDomainRequest,t)):void 0},a=function(){return e.getOption("interceptRequests")&&e.onXHR(function(t){var i;return i=t.xhr,i.offline!==!1?n(i,e.confirmUp,e.confirmDown):void 0}),e.getOption("checkOnLoad")?e.check():void 0},setTimeout(a,0),window.Offline=e}.call(this),function(){var e,n,t,i,o,r,a,s,u;if(!window.Offline)throw new Error("Offline Reconnect brought in without offline.js");i=Offline.reconnect={},r=null,o=function(){var e;return null!=i.state&&"inactive"!==i.state&&Offline.trigger("reconnect:stopped"),i.state="inactive",i.remaining=i.delay=null!=(e=Offline.getOption("reconnect.initialDelay"))?e:3},n=function(){var e,n;return e=null!=(n=Offline.getOption("reconnect.delay"))?n:Math.min(Math.ceil(1.5*i.delay),3600),i.remaining=i.delay=e},a=function(){return"connecting"!==i.state?(i.remaining-=1,Offline.trigger("reconnect:tick"),0===i.remaining?s():void 0):void 0},s=function(){return"waiting"===i.state?(Offline.trigger("reconnect:connecting"),i.state="connecting",Offline.check()):void 0},e=function(){return Offline.getOption("reconnect")?(o(),i.state="waiting",Offline.trigger("reconnect:started"),r=setInterval(a,1e3)):void 0},u=function(){return null!=r&&clearInterval(r),o()},t=function(){return Offline.getOption("reconnect")&&"connecting"===i.state?(Offline.trigger("reconnect:failure"),i.state="waiting",n()):void 0},i.tryNow=s,o(),Offline.on("down",e),Offline.on("confirmed-down",t),Offline.on("up",u)}.call(this),function(){var e,n,t,i,o,r;if(!window.Offline)throw new Error("Requests module brought in without offline.js");t=[],r=!1,i=function(e){return Offline.trigger("requests:capture"),"down"!==Offline.state&&(r=!0),t.push(e)},o=function(e){var n,t,i,o,r,a,s,u,c;u=e.xhr,r=e.url,o=e.type,a=e.user,i=e.password,n=e.body,u.abort(),u.open(o,r,!0,a,i),c=u.headers;for(t in c)s=c[t],u.setRequestHeader(t,s);return u.mimeType&&u.overrideMimeType(u.mimeType),u.send(n)},e=function(){return t=[]},n=function(){var n,i,r,a,s,u;for(Offline.trigger("requests:flush"),r={},s=0,u=t.length;u>s;s++)i=t[s],a=i.url.replace(/(\?|&)_=[0-9]+/,function(e,n){return"?"===n?n:""}),r[""+i.type.toUpperCase()+" - "+a]=i;for(n in r)i=r[n],o(i);return e()},setTimeout(function(){return Offline.getOption("requests")!==!1?(Offline.on("confirmed-up",function(){return r?(r=!1,e()):void 0}),Offline.on("up",n),Offline.on("down",function(){return r=!1}),Offline.onXHR(function(e){var n,t,o,r,a;return o=e.xhr,n=e.async,o.offline!==!1&&(t=function(){return i(e)},a=o.send,o.send=function(n){return e.body=n,a.apply(o,arguments)},n)?null===o.onprogress?(o.addEventListener("error",t,!1),o.addEventListener("timeout",t,!1)):(r=o.onreadystatechange,o.onreadystatechange=function(){return 0===o.readyState?t():4===o.readyState&&(0===o.status||o.status>=12e3)&&t(),"function"==typeof r?r.apply(null,arguments):void 0}):void 0}),Offline.requests={flush:n,clear:e}):void 0},0)}.call(this),function(){var e,n,t,i,o;if(!Offline)throw new Error("Offline simulate brought in without offline.js");for(o=["up","down"],t=0,i=o.length;i>t;t++)e=o[t],(document.querySelector("script[data-simulate='"+e+"']")||localStorage.OFFLINE_SIMULATE===e)&&(null==Offline.options&&(Offline.options={}),null==(n=Offline.options).checks&&(n.checks={}),Offline.options.checks.active=e)}.call(this),function(){var e,n,t,i,o,r,a,s,u,c,l,f,d;if(!window.Offline)throw new Error("Offline UI brought in without offline.js");n='<div class="offline-ui"><div class="offline-ui-content"></div></div>',e='<a href class="offline-ui-retry"></a>',o=function(e){var n;return n=document.createElement("div"),n.innerHTML=e,n.children[0]},r=i=null,t=function(e){return c(e),r.className+=" "+e},c=function(e){return r.className=r.className.replace(new RegExp("(^| )"+e.split(" ").join("|")+"( |$)","gi")," ")},s={},a=function(e,n){return t(e),null!=s[e]&&clearTimeout(s[e]),s[e]=setTimeout(function(){return c(e),delete s[e]},1e3*n)},f=function(e){var n,t,i,o;i={day:86400,hour:3600,minute:60,second:1};for(t in i)if(n=i[t],e>=n)return o=Math.floor(e/n),[o,t];return["now",""]},l=function(){var a,s;return r=o(n),document.body.appendChild(r),null!=Offline.reconnect&&Offline.getOption("reconnect")&&(r.appendChild(o(e)),a=r.querySelector(".offline-ui-retry"),s=function(e){return e.preventDefault(),Offline.reconnect.tryNow()},null!=a.addEventListener?a.addEventListener("click",s,!1):a.attachEvent("click",s)),t("offline-ui-"+Offline.state),i=r.querySelector(".offline-ui-content")},u=function(){return l(),Offline.on("up",function(){return c("offline-ui-down"),t("offline-ui-up"),a("offline-ui-up-2s",2),a("offline-ui-up-5s",5)}),Offline.on("down",function(){return c("offline-ui-up"),t("offline-ui-down"),a("offline-ui-down-2s",2),a("offline-ui-down-5s",5)}),Offline.on("reconnect:connecting",function(){return t("offline-ui-connecting"),c("offline-ui-waiting")}),Offline.on("reconnect:tick",function(){var e,n,o;return t("offline-ui-waiting"),c("offline-ui-connecting"),o=f(Offline.reconnect.remaining),e=o[0],n=o[1],i.setAttribute("data-retry-in-value",e),i.setAttribute("data-retry-in-unit",n)}),Offline.on("reconnect:stopped",function(){return c("offline-ui-connecting offline-ui-waiting"),i.setAttribute("data-retry-in-value",null),i.setAttribute("data-retry-in-unit",null)}),Offline.on("reconnect:failure",function(){return a("offline-ui-reconnect-failed-2s",2),a("offline-ui-reconnect-failed-5s",5)}),Offline.on("reconnect:success",function(){return a("offline-ui-reconnect-succeeded-2s",2),a("offline-ui-reconnect-succeeded-5s",5)})},"complete"===document.readyState?u():null!=document.addEventListener?document.addEventListener("DOMContentLoaded",u,!1):(d=document.onreadystatechange,document.onreadystatechange=function(){return"complete"===document.readyState&&u(),"function"==typeof d?d.apply(null,arguments):void 0})}.call(this),+function(e){"use strict";var n=function(t,i){this.$element=e(t),this.options=e.extend({},n.DEFAULTS,i),this.transitioning=null,this.options.parent&&(this.$parent=e(this.options.parent)),this.options.toggle&&this.toggle()};n.DEFAULTS={toggle:!0},n.prototype.show=function(){if(!this.transitioning&&!this.$element.hasClass("sidebar-open")){var n=e.Event("show.bs.sidebar");if(this.$element.trigger(n),!n.isDefaultPrevented()){this.$element.addClass("sidebar-open"),this.transitioning=1;var t=function(){this.$element,this.transitioning=0,this.$element.trigger("shown.bs.sidebar")};return e.support.transition?void this.$element.one(e.support.transition.end,e.proxy(t,this)).emulateTransitionEnd(400):t.call(this)}}},n.prototype.hide=function(){if(!this.transitioning&&this.$element.hasClass("sidebar-open")){var n=e.Event("hide.bs.sidebar");if(this.$element.trigger(n),!n.isDefaultPrevented()){this.$element.removeClass("sidebar-open"),this.transitioning=1;var t=function(){this.transitioning=0,this.$element.trigger("hidden.bs.sidebar")};return e.support.transition?void this.$element.one(e.support.transition.end,e.proxy(t,this)).emulateTransitionEnd(400):t.call(this)}}},n.prototype.toggle=function(){this[this.$element.hasClass("sidebar-open")?"hide":"show"]()};var t=e.fn.sidebar;e.fn.sidebar=function(t){return this.each(function(){var i=e(this),o=i.data("bs.sidebar"),r=e.extend({},n.DEFAULTS,i.data(),"object"==typeof r&&t);!o&&r.toggle&&"show"==t&&(t=!t),o||i.data("bs.sidebar",o=new n(this,r)),"string"==typeof t&&o[t]()})},e.fn.sidebar.Constructor=n,e.fn.sidebar.noConflict=function(){return e.fn.sidebar=t,this},e(document).on("click.bs.sidebar.data-api",'[data-toggle="sidebar"]',function(n){var t,i=e(this),o=i.attr("data-target")||n.preventDefault()||(t=i.attr("href"))&&t.replace(/.*(?=#[^\s]+$)/,""),r=e(o),a=r.data("bs.sidebar"),s=a?"toggle":i.data();r.sidebar(s)}),e("html").on("click.bs.sidebar.autohide",function(n){var t=e(n.target),i=t.is('.sidebar, [data-toggle="sidebar"]')||t.parents('.sidebar, [data-toggle="sidebar"]').length;if(!i){var o=e(".sidebar");o.each(function(n,t){var i=e(t);i.data("bs.sidebar")&&i.hasClass("sidebar-open")&&i.sidebar("hide")})}})}(jQuery);